# 7장 아키텍처 요소 테스트하기

육각형 아키텍처에서의 테스트 전략에 대해 이야기한다.  
아키텍처의 각 요소들을 테스트할 수 있는 테스트 유형에 대해 논의할 것이다.

<br/>

## 테스트 피라미드
비용이 많이 드는 테스트는 지양하고 비용이 적게 드는 테스트를 많이 만들어야 한다.

시스템 테스트   
\--------\-----  
 통합 테스트  
\--------------------  
 단위테스트

<br/>

- 단위테스트 

    - 피라미드의 토대에 해당
    - 하나의 클래스를 인스턴스화 하고 해당 클래스의 인터페이스를 통해 기능들을 테스트
    - 의존되는 클래스들은 테스트하는 동안 필요한 작업들을 흉내내는 목으로 대체

- 통합 테스트

    - 연결된 여러 유닛을 인스턴스화
    - 시작점이 되는 클래스의 인터페이스로 데이터를 보낸 후 
    - 유닛들의 네트워크가 기대한대로 잘 동작 하는지 검증

- 시스템 테스트

    - 애플리케이션을 구성하는 모든 객체 네트워크를 가동
    - 특정 유스케이스가 전계층에 잘 동작하는지 검증


<br/>
<br/>

## 단위 테스트

### 도메인 엔티티 테스트 하기

- 단위테스트가 도메인 엔티티에 녹아있는 비즈니스 규칙을 검증하기 가장 적절한 방법이다.
- 도메인 엔티티의 행동은 다른 클래스에 거의 의존하지 않기 때문에 다른 종류의 테스트는 필요하지 않다.

<br/>  

### 유스케이스 테스트하기

- 테스트에서 어떤 상호작용을 검증하고 싶은지 신중하게 생각해야 한다.
- 모든 동작을 검증하는 대신 중요한 핵심만 골라 집중해서 테스트하는 것이 좋다.
- 모든 동작을 검증하려고 하면 클래스가 조금이라도 바뀔 때마다 테스트를 변경해야 한다.   
→ 이는 테스트의 가치를 떨어뜨리는 일이다.


 <br/>
 <br/> 

## 통합테스트

### 웹 어댑터 테스트하기

- JSON 문자열 등의 형태로 HTTP를 통해 입력을 받음 →  입력에 대한 유효성 검증   
→  유스케이스에서 사용할 수 있는 포맷으로 매핑 → 유스케이스에 전달   
→ 유스케이스의 결과를 JSON으로 매핑 → HTTP응답을 통해 클라이언트에 반환
- MockMvc 객체를 이용해 모킹 : HTTP 응답 검증
- 통합테스트인 이유

    - `@WebMvcTest` 애너테이션

        - 스프링이 특정 요청 경로, 자바와 JSON간의 매핑, HTTP 입력 검증 등에 필요한 전체 객체 네트워크를 인스턴스화 하도록 만든다.
        - 웹 컨트롤러가 이 네트워크 일부로서 잘 동작하는지 검증

- 웹 컨트롤러가 스프링 프레임워크에 강하게 묶여 있다. →  프레임워크와 통합된 상태로 테스트하는 것이 합리적이다.

<br/>  

### 영속성 어댑터 테스트하기

- 단순히 어댑터로만의 검증이 아닌 데이터베이스 매핑도 검증
- 데이터베이스를 모킹하지 않고 실제로 데이터베이스에 접근한다.

    - 스프링은 기본적으로 인메모리 데이터베이스를 테스트에서 사용한다.
    - 하지만 실제 데이터베이스에서는 문제가 생길 확률이 높다.   
    ex) SQL 문법 / 데이터베이스 테이블과 객체 간의 매핑 등

  

## 시스템 테스트

### 주요 경로 테스트

- 전체 애플리케이션을 띄우고 API를 통해 요청을 보내고, 모든 계층이 조화롭게 잘 동작하는지 검증한다.
- MockMvc를 사용하지 않고 실제 HTTP 통신을 통해 테스트 한다.
- 사용자 관점에서의 애플리케이션을 검증할 수 있다.
- 단위 테스트와 통합 테스트를 만들었다면 시스템 테스트는 앞서 커버한 코드와 겹치는 부분이 많을 것이다.

    - 그러나 앞서 커버한 테스트들과는 다른 종류의 버그를 발견해서 수정할 수 있게 해준다.  
    ex) 계층 간 매핑 버그 등


<br/>
<br/>  

## 얼마만큼의 테스트가 충분할까

- 얼마나 마음 편하게 소프트웨어를 배포할 수 있느냐를 테스트의 성공 기준으로 삼자.
- 각각의 프로덕션 버그에 대해서 “테스트가 이 버그를 왜 잡지 못했을까?”를 생각하고
    - 답변을 기록한다.
    - 이 케이스를 커버할 수 있는 테스트를 추가한다.
- 리팩터링할 때마다 테스트 코드도 변경해야 한다면 테스트는 테스트로서의 가치를 잃는다.

<br/> 

### 육각형 아키텍처에서 사용하는 전략

- 도메인 엔티티를 구현할 때는 단위 테스트로 커버하자.
- 유스케이스를 구현할 때는 단위테스트로 커버하자.
- 어댑터를 구현할 때는 통합테스트로 커버하자.
- 사용자가 취할 수 있는 애플리케이션 경로는 시스템 테스트로 커버하자.